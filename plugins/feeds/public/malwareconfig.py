import logging
from datetime import datetime, timedelta

from dateutil import parser

from core.errors import ObservableValidationError
from core.feed import Feed
from core.observables import Hash, Hostname, Ip, Url


class MalwareConfig(Feed):

    default_values = {
        "frequency": timedelta(minutes=60),
        "name": "MalwareConfig",
        "source": "https://malwareconfig.com/static/C2_24.csv",
        "description": "MalwareConfig offers list of submitted files along extracted c2 servers and malware family.",
    }

    def update(self):

        since_last_run = datetime.now() - self.frequency

        # When used for the first time, get all data
        if self.last_run is None:
            self.source = "https://malwareconfig.com/static/C2_All.csv"

        for line in self.update_csv(delimiter=",", verify=False):

            if not line or line[0].startswith("#"):
                continue

            map(lambda x: x.stip(), line)
            first_seen = parser.parse(line[5])
            if self.last_run is not None:
                if since_last_run > first_seen:
                    break

            self.analyze(line)

        self.source = self.default_values["source"]

    def analyze(self, line):  # pylint: disable=arguments-differ

        try:
            ip, domain, family, md5, link, date = tuple(map(strip, line))
            context = {
                "first_seen": date,
                "family": family,
                "report": link,
                "source": self.name,
            }

            c2 = None
            sample = None

            try:
                sample = Hash.get_or_create(value=md5)
                sample.add_context(context)
                sample.tag(family.lower())
            except ObservableValidationError as e:
                logging.error("Invalid line: {}\nLine: {}".format(e, line))

            try:
                if domain:
                    if "/" in domain:
                        c2 = Url.get_or_create(value=domain)
                    else:
                        c2 = Hostname.get_or_create(value=domain)
                elif ip:
                    c2 = Ip.get_or_create(value=ip)
                else:
                    return

                c2.add_context(context)
                c2.tag(["c2", family.lower()])

            except ObservableValidationError as e:
                logging.error("Invalid line: {}\nLine: {}".format(e, line))

            if c2 and sample:
                sample.active_link_to(c2, "c2", self.name, clean_old=False)

        except ValueError:
            logging.error("Error unpacking line: {}".format(line))
